<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BP Logger</title>
  <style>
    :root{
      --bg: #0b0b0f;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.09);
      --text: #f5f5f5;
      --muted: rgba(245,245,245,0.65);
      --line: rgba(255,255,255,0.12);
      --accent: #ffc300; /* dark yellow */
      --accent2: #d4a600;
      --danger: #ff4d4d;
      --shadow: 0 18px 50px rgba(0,0,0,0.55);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(900px 600px at 20% 0%, rgba(255,195,0,0.18), transparent 55%),
        radial-gradient(800px 520px at 100% 20%, rgba(255,195,0,0.10), transparent 55%),
        radial-gradient(900px 700px at 40% 120%, rgba(255,255,255,0.06), transparent 55%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 28px 18px 70px;
    }

    .wrap{ max-width: 1050px; margin: 0 auto; }

    header{
      display:flex;
      gap: 14px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }
    .brand{ display:flex; flex-direction: column; gap: 4px; }
    .title{
      font-size: 22px;
      letter-spacing: 0.5px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: wrap;
    }
    .badge{
      font-family: var(--mono);
      font-size: 12px;
      color: #111;
      background: var(--accent);
      padding: 4px 8px;
      border-radius: 999px;
      box-shadow: 0 8px 24px rgba(255,195,0,0.22);
    }
    .subtitle{ color: var(--muted); font-size: 13px; }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap: 18px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.03));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .card-h{
      padding: 16px 16px 12px;
      border-bottom: 1px solid var(--line);
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .card .card-h h2{
      font-size: 14px;
      margin:0;
      color: rgba(245,245,245,0.92);
      letter-spacing: 0.7px;
      text-transform: uppercase;
    }
    .card .card-b{ padding: 16px; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 560px){
      .row{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(10,10,14,0.75);
      color: var(--text);
      outline: none;
    }
    input:focus, select:focus{
      border-color: rgba(255,195,0,0.65);
      box-shadow: 0 0 0 4px rgba(255,195,0,0.15);
    }

    .actions{
      display:flex;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
    }
    button{
      cursor:pointer;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 11px 14px;
      border-radius: 12px;
      transition: transform 0.05s ease, border-color 0.2s ease, background 0.2s ease;
      display:flex;
      gap: 10px;
      align-items:center;
      font-weight: 600;
      letter-spacing: 0.2px;
    }
    button:hover{
      border-color: rgba(255,195,0,0.5);
      background: rgba(255,195,0,0.08);
    }
    button:active{ transform: translateY(1px); }

    .primary{
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      color: #141414;
      border-color: rgba(255,195,0,0.75);
    }
    .primary:hover{
      background: linear-gradient(180deg, #ffd44d, var(--accent));
    }

    .danger{
      border-color: rgba(255,77,77,0.35);
    }
    .danger:hover{
      border-color: rgba(255,77,77,0.7);
      background: rgba(255,77,77,0.08);
    }

    .pill{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(245,245,245,0.9);
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--line);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 560px){
      .stats{ grid-template-columns: 1fr; }
    }

    .stat{
      background: linear-gradient(180deg, var(--panel2), rgba(255,255,255,0.04));
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
    }
    .stat .k{
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 6px;
    }
    .stat .v{
      font-size: 18px;
      display:flex;
      align-items: baseline;
      gap: 8px;
      font-family: var(--mono);
      flex-wrap: wrap;
    }
    .stat .v small{
      font-size: 12px;
      color: var(--muted);
      font-family: var(--sans);
    }

    .divider{
      height:1px;
      background: var(--line);
      margin: 14px 0;
    }

    .list{
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .item{
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.04);
      border-radius: 16px;
      padding: 12px 12px;
      display:flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .item-left{
      display:flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }
    .bp{
      font-family: var(--mono);
      font-size: 16px;
      display:flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .bp .tag{
      font-family: var(--mono);
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: rgba(245,245,245,0.85);
      background: rgba(255,255,255,0.05);
    }
    .meta{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 680px;
    }

    .smallbtn{
      padding: 9px 11px;
      border-radius: 12px;
      font-weight: 700;
      font-family: var(--mono);
      letter-spacing: 0.2px;
    }

    .footer-note{
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
      line-height: 1.45;
    }

    .hint{
      color: rgba(245,245,245,0.75);
      font-size: 12px;
      margin-top: 10px;
      border-top: 1px solid var(--line);
      padding-top: 10px;
      line-height: 1.45;
    }
    .hint b{ color: rgba(245,245,245,0.95); }

    .empty{
      color: var(--muted);
      font-size: 13px;
      padding: 6px 2px;
    }

    /* Chart */
    .chart-wrap{
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.04);
      border-radius: 16px;
      padding: 12px;
    }
    canvas{
      width: 100%;
      height: 190px;
      display:block;
    }
    .chart-legend{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
    }
    .dot{
      width: 10px; height: 10px; border-radius: 999px;
      border: 1px solid var(--line);
      display:inline-block;
      margin-right: 6px;
    }
    .dot.sys{ background: rgba(255,195,0,0.95); }
    .dot.dia{ background: rgba(245,245,245,0.95); }

    /* Lock overlay */
    .lock{
      position: fixed;
      inset: 0;
      background:
        radial-gradient(900px 600px at 20% 0%, rgba(255,195,0,0.18), transparent 55%),
        rgba(0,0,0,0.78);
      backdrop-filter: blur(10px);
      display:none;
      align-items: center;
      justify-content: center;
      padding: 22px;
      z-index: 9999;
    }
    .lock-card{
      width: min(520px, 100%);
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.03));
      border: 1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .lock-h{
      padding: 16px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }
    .lock-h .t{
      font-weight: 800;
      letter-spacing: 0.3px;
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .lock-b{ padding: 16px; }
    .lock-msg{
      color: var(--muted);
      font-size: 13px;
      margin: 0 0 12px;
      line-height: 1.45;
    }
    .lock-row{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .lock-err{
      color: rgba(255,77,77,0.95);
      font-size: 12px;
      min-height: 16px;
      margin-top: 6px;
    }

    .right-tools{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items:center;
    }
  </style>
</head>
<body>
  <!-- PIN lock overlay -->
  <div class="lock" id="lockOverlay">
    <div class="lock-card">
      <div class="lock-h">
        <div class="t">üîí BP Logger <span class="badge">PIN</span></div>
        <div class="pill" id="lockTimePill">‚Ä¶</div>
      </div>
      <div class="lock-b">
        <p class="lock-msg">Enter your PIN to unlock your readings.</p>
        <div class="lock-row">
          <div>
            <label for="pinInput">PIN</label>
            <input id="pinInput" type="password" inputmode="numeric" placeholder="4‚Äì8 digits" autocomplete="current-password">
            <div class="lock-err" id="pinError"></div>
          </div>
        </div>
        <div class="actions">
          <button class="primary" id="unlockBtn">üîì Unlock</button>
          <button id="lockHelpBtn">üß† Forgot?</button>
        </div>
        <div class="hint">
          If you forget your PIN, you can still reset it, but you‚Äôll need to <b>clear app data</b> on this device (localStorage).
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="title">BP Logger <span class="badge">BLACK ‚Ä¢ YELLOW ‚Ä¢ WHITE</span></div>
        <div class="subtitle">Log BP with timestamps, trends, and doctor-friendly exports. üìà</div>
      </div>

      <div class="right-tools">
        <div class="pill" id="nowPill">Loading time‚Ä¶</div>
        <button id="lockBtn" title="Lock / PIN settings">üîí PIN</button>
      </div>
    </header>

    <div class="grid">
      <!-- Add entry -->
      <section class="card">
        <div class="card-h">
          <h2>Add entry</h2>
          <span class="pill" id="entryCount">0 entries</span>
        </div>
        <div class="card-b">
          <div class="row">
            <div>
              <label for="sys">Systolic (SYS)</label>
              <input id="sys" type="number" inputmode="numeric" min="50" max="260" placeholder="e.g. 120">
            </div>
            <div>
              <label for="dia">Diastolic (DIA)</label>
              <input id="dia" type="number" inputmode="numeric" min="30" max="160" placeholder="e.g. 80">
            </div>
            <div>
              <label for="pulse">Pulse (optional)</label>
              <input id="pulse" type="number" inputmode="numeric" min="30" max="220" placeholder="e.g. 65">
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <div>
              <label for="tod">Time of day</label>
              <select id="tod">
                <option value="Morning">Morning</option>
                <option value="Evening">Evening</option>
              </select>
            </div>
            <div>
              <label for="arm">Arm (optional)</label>
              <select id="arm">
                <option value="">Not set</option>
                <option value="Left">Left</option>
                <option value="Right">Right</option>
              </select>
            </div>
            <div>
              <label for="timeMode">Timestamp</label>
              <select id="timeMode">
                <option value="now">Use current date/time</option>
                <option value="manual">Pick date/time</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <div style="grid-column: 1 / -1;">
              <label for="note">Note (optional)</label>
              <input id="note" type="text" placeholder="e.g. before breakfast, after coffee, post-walk">
            </div>
          </div>

          <div class="row" id="manualTimeRow" style="margin-top:12px; display:none;">
            <div style="grid-column: 1 / -1;">
              <label for="manualTime">Manual date/time</label>
              <input id="manualTime" type="datetime-local">
            </div>
          </div>

          <div class="actions">
            <button class="primary" id="addBtn">‚ûï Add reading</button>
            <button id="exportCsvBtn">üßæ Export CSV</button>
            <button id="exportJsonBtn">‚¨áÔ∏è Export JSON</button>
            <button class="danger" id="clearBtn">üóëÔ∏è Clear all</button>
          </div>

          <div class="footer-note">
            Stored on this device (localStorage). Export CSV for your GP, export JSON as a backup.
          </div>
        </div>
      </section>

      <!-- Stats + chart -->
      <aside class="card">
        <div class="card-h">
          <h2>Trends & averages</h2>
          <span class="pill" id="latestPill">No entries yet</span>
        </div>
        <div class="card-b">
          <div class="chart-wrap">
            <canvas id="chart" width="900" height="300"></canvas>
            <div class="chart-legend">
              <span><span class="dot sys"></span>SYS</span>
              <span><span class="dot dia"></span>DIA</span>
              <span class="pill" id="chartRangePill">Last 30 entries</span>
            </div>
          </div>

          <div class="divider"></div>

          <div class="stats">
            <div class="stat">
              <div class="k">All-time avg</div>
              <div class="v" id="avgAll">‚Äì <small>SYS/DIA</small></div>
            </div>
            <div class="stat">
              <div class="k">Avg pulse</div>
              <div class="v" id="avgPulse">‚Äì <small>bpm</small></div>
            </div>

            <div class="stat">
              <div class="k">Morning avg</div>
              <div class="v" id="avgMorning">‚Äì <small>SYS/DIA</small></div>
            </div>
            <div class="stat">
              <div class="k">Evening avg</div>
              <div class="v" id="avgEvening">‚Äì <small>SYS/DIA</small></div>
            </div>

            <div class="stat">
              <div class="k">Last 7 days</div>
              <div class="v" id="avg7">‚Äì <small>SYS/DIA</small></div>
            </div>
            <div class="stat">
              <div class="k">Last 30 days</div>
              <div class="v" id="avg30">‚Äì <small>SYS/DIA</small></div>
            </div>
          </div>

          <div class="hint">
            Pro tip: If you do <b>two readings</b> per session, log both and the averages will reflect it.
          </div>
        </div>
      </aside>

      <!-- Log list -->
      <section class="card" style="grid-column: 1 / -1;">
        <div class="card-h">
          <h2>Log</h2>
          <span class="pill" id="countPill">0 entries</span>
        </div>
        <div class="card-b">
          <div class="list" id="list"></div>
          <div class="empty" id="emptyState" style="display:none;">No readings yet. Add your first one above.</div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ----------------------------
    // Storage keys
    // ----------------------------
    const STORAGE_KEY = "bp_logger_entries_v2";
    const PIN_HASH_KEY = "bp_logger_pin_hash_v1";

    const el = (id) => document.getElementById(id);

    // Inputs
    const sys = el("sys");
    const dia = el("dia");
    const pulse = el("pulse");
    const tod = el("tod");
    const arm = el("arm");
    const note = el("note");
    const timeMode = el("timeMode");
    const manualTimeRow = el("manualTimeRow");
    const manualTime = el("manualTime");

    // Buttons
    const addBtn = el("addBtn");
    const clearBtn = el("clearBtn");
    const exportJsonBtn = el("exportJsonBtn");
    const exportCsvBtn = el("exportCsvBtn");
    const lockBtn = el("lockBtn");

    // UI nodes
    const list = el("list");
    const emptyState = el("emptyState");
    const nowPill = el("nowPill");
    const entryCount = el("entryCount");
    const countPill = el("countPill");
    const latestPill = el("latestPill");

    // Averages
    const avg7 = el("avg7");
    const avg30 = el("avg30");
    const avgAll = el("avgAll");
    const avgPulse = el("avgPulse");
    const avgMorning = el("avgMorning");
    const avgEvening = el("avgEvening");

    // Chart
    const canvas = el("chart");
    const ctx = canvas.getContext("2d");
    const chartRangePill = el("chartRangePill");

    // Lock UI
    const lockOverlay = el("lockOverlay");
    const pinInput = el("pinInput");
    const pinError = el("pinError");
    const unlockBtn = el("unlockBtn");
    const lockHelpBtn = el("lockHelpBtn");
    const lockTimePill = el("lockTimePill");

    // ----------------------------
    // Helpers
    // ----------------------------
    function formatDateTime(ts){
      const d = new Date(ts);
      return d.toLocaleString(undefined, {
        weekday: "short",
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function formatISOForCsv(ts){
      const d = new Date(ts);
      const pad = (n) => String(n).padStart(2,"0");
      const y = d.getFullYear();
      const m = pad(d.getMonth()+1);
      const day = pad(d.getDate());
      const hh = pad(d.getHours());
      const mm = pad(d.getMinutes());
      return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    function loadEntries(){
      try{
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      }catch{
        return [];
      }
    }
    function saveEntries(entries){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
    }

    function clamp(n, min, max){ return Math.min(max, Math.max(min, n)); }
    function num(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function calcAvg(entries){
      if(!entries.length) return null;
      const avg = (arr) => arr.reduce((a,b)=>a+b,0) / arr.length;

      const sysVals = entries.map(e=>e.sys).filter(v=>Number.isFinite(v));
      const diaVals = entries.map(e=>e.dia).filter(v=>Number.isFinite(v));
      if(!sysVals.length || !diaVals.length) return null;

      const out = { sys: avg(sysVals), dia: avg(diaVals), pulse: null };

      const pulseVals = entries.map(e=>e.pulse).filter(v=>Number.isFinite(v));
      if(pulseVals.length) out.pulse = avg(pulseVals);

      return out;
    }

    function withinDays(entries, days){
      const now = Date.now();
      const ms = days * 24 * 60 * 60 * 1000;
      return entries.filter(e => (now - e.ts) <= ms);
    }

    // ----------------------------
    // PIN lock
    // ----------------------------
    function getPinHash(){
      return localStorage.getItem(PIN_HASH_KEY) || "";
    }
    function hasPin(){
      return !!getPinHash();
    }

    async function sha256Hex(text){
      const enc = new TextEncoder();
      const data = enc.encode(text);
      const buf = await crypto.subtle.digest("SHA-256", data);
      const arr = Array.from(new Uint8Array(buf));
      return arr.map(b => b.toString(16).padStart(2, "0")).join("");
    }

    function showLock(){
      pinInput.value = "";
      pinError.textContent = "";
      lockOverlay.style.display = "flex";
      pinInput.focus();
    }
    function hideLock(){
      lockOverlay.style.display = "none";
    }

    async function tryUnlock(){
      const pin = (pinInput.value || "").trim();
      if(pin.length < 4 || pin.length > 8 || !/^\d+$/.test(pin)){
        pinError.textContent = "PIN must be 4‚Äì8 digits.";
        return;
      }
      const entered = await sha256Hex(pin);
      if(entered !== getPinHash()){
        pinError.textContent = "Nope. That PIN doesn‚Äôt match.";
        return;
      }
      hideLock();
    }

    async function pinSettingsFlow(){
      // Very lightweight flow using prompts (simple + reliable)
      // Options: set/change/remove
      if(!hasPin()){
        const pin = prompt("Set a new PIN (4‚Äì8 digits):");
        if(pin === null) return;
        const p = pin.trim();
        if(p.length < 4 || p.length > 8 || !/^\d+$/.test(p)){
          alert("PIN must be 4‚Äì8 digits.");
          return;
        }
        const hash = await sha256Hex(p);
        localStorage.setItem(PIN_HASH_KEY, hash);
        alert("PIN set ‚úÖ Next time you refresh, it will lock.");
        return;
      }

      const choice = prompt("PIN is enabled.\nType:\n1 = Change PIN\n2 = Remove PIN\n(Anything else cancels)");
      if(choice === null) return;

      if(choice.trim() === "2"){
        const confirmRemove = confirm("Remove PIN lock?");
        if(!confirmRemove) return;
        localStorage.removeItem(PIN_HASH_KEY);
        alert("PIN removed ‚úÖ");
        return;
      }

      if(choice.trim() === "1"){
        const current = prompt("Enter current PIN:");
        if(current === null) return;
        const currHash = await sha256Hex(current.trim());
        if(currHash !== getPinHash()){
          alert("Current PIN incorrect.");
          return;
        }
        const next = prompt("Enter new PIN (4‚Äì8 digits):");
        if(next === null) return;
        const n = next.trim();
        if(n.length < 4 || n.length > 8 || !/^\d+$/.test(n)){
          alert("PIN must be 4‚Äì8 digits.");
          return;
        }
        const nextHash = await sha256Hex(n);
        localStorage.setItem(PIN_HASH_KEY, nextHash);
        alert("PIN changed ‚úÖ");
        return;
      }
    }

    // ----------------------------
    // Chart drawing (no libraries)
    // ----------------------------
    function drawChart(entries){
      // Show last N points to keep it clean on small screens
      const N = 30;
      const points = entries.slice(0, N).reverse(); // oldest -> newest
      chartRangePill.textContent = points.length ? `Last ${Math.min(N, entries.length)} entries` : "No data";

      // Clear
      ctx.clearRect(0,0,canvas.width, canvas.height);

      // Background subtle grid
      const w = canvas.width, h = canvas.height;
      ctx.save();
      ctx.globalAlpha = 1;

      // Panel background gradient
      const bg = ctx.createLinearGradient(0,0,0,h);
      bg.addColorStop(0, "rgba(255,255,255,0.03)");
      bg.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = bg;
      ctx.fillRect(0,0,w,h);

      const padL = 52, padR = 14, padT = 14, padB = 34;
      const innerW = w - padL - padR;
      const innerH = h - padT - padB;

      // If no points, draw message
      if(points.length < 2){
        ctx.fillStyle = "rgba(245,245,245,0.65)";
        ctx.font = "16px ui-monospace, Menlo, monospace";
        ctx.fillText("Add a couple readings to see a trend.", padL, padT + 26);
        ctx.restore();
        return;
      }

      // Determine ranges
      const sysVals = points.map(p=>p.sys);
      const diaVals = points.map(p=>p.dia);
      const all = sysVals.concat(diaVals);

      let minV = Math.min(...all);
      let maxV = Math.max(...all);

      // Add padding so lines aren't glued to edges
      const extra = Math.max(8, (maxV - minV) * 0.12);
      minV = Math.floor(minV - extra);
      maxV = Math.ceil(maxV + extra);

      const xAt = (i) => padL + (i/(points.length-1))*innerW;
      const yAt = (v) => padT + (1 - ((v - minV)/(maxV - minV))) * innerH;

      // Grid lines + labels
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineWidth = 1;
      ctx.setLineDash([4,6]);

      const ticks = 4;
      for(let t=0; t<=ticks; t++){
        const y = padT + (t/ticks)*innerH;
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL + innerW, y);
        ctx.stroke();

        // label on left
        const v = (maxV - (t/ticks)*(maxV - minV));
        ctx.setLineDash([]);
        ctx.fillStyle = "rgba(245,245,245,0.55)";
        ctx.font = "12px ui-monospace, Menlo, monospace";
        ctx.fillText(String(Math.round(v)), 10, y + 4);
        ctx.setLineDash([4,6]);
      }
      ctx.setLineDash([]);

      // Axes
      ctx.strokeStyle = "rgba(255,255,255,0.14)";
      ctx.beginPath();
      ctx.moveTo(padL, padT);
      ctx.lineTo(padL, padT + innerH);
      ctx.lineTo(padL + innerW, padT + innerH);
      ctx.stroke();

      // SYS line (yellow)
      function drawLine(values, color, alpha){
        ctx.beginPath();
        for(let i=0; i<values.length; i++){
          const x = xAt(i);
          const y = yAt(values[i]);
          if(i === 0) ctx.moveTo(x,y);
          else ctx.lineTo(x,y);
        }
        ctx.strokeStyle = color;
        ctx.globalAlpha = alpha;
        ctx.lineWidth = 3;
        ctx.stroke();

        // points
        ctx.globalAlpha = 1;
        for(let i=0; i<values.length; i++){
          const x = xAt(i);
          const y = yAt(values[i]);
          ctx.beginPath();
          ctx.fillStyle = "rgba(0,0,0,0.55)";
          ctx.arc(x,y,5,0,Math.PI*2);
          ctx.fill();
          ctx.beginPath();
          ctx.fillStyle = color;
          ctx.arc(x,y,3,0,Math.PI*2);
          ctx.fill();
        }
      }

      drawLine(sysVals, "rgba(255,195,0,0.95)", 0.95);
      drawLine(diaVals, "rgba(245,245,245,0.92)", 0.90);

      // Bottom labels (first/last)
      ctx.fillStyle = "rgba(245,245,245,0.55)";
      ctx.font = "12px ui-monospace, Menlo, monospace";
      const first = new Date(points[0].ts).toLocaleDateString(undefined, {month:"short", day:"2-digit"});
      const last = new Date(points[points.length-1].ts).toLocaleDateString(undefined, {month:"short", day:"2-digit"});
      ctx.fillText(first, padL, padT + innerH + 22);
      ctx.fillText(last, padL + innerW - ctx.measureText(last).width, padT + innerH + 22);

      ctx.restore();
    }

    // ----------------------------
    // Rendering
    // ----------------------------
    function render(){
      const entries = loadEntries().sort((a,b)=>b.ts - a.ts);

      entryCount.textContent = `${entries.length} ${entries.length === 1 ? "entry" : "entries"}`;
      countPill.textContent = `${entries.length} total`;
      latestPill.textContent = entries.length ? `Latest: ${formatDateTime(entries[0].ts)}` : "No entries yet";

      // List
      list.innerHTML = "";
      emptyState.style.display = entries.length ? "none" : "block";

      for(const e of entries){
        const item = document.createElement("div");
        item.className = "item";

        const left = document.createElement("div");
        left.className = "item-left";

        const bp = document.createElement("div");
        bp.className = "bp";
        bp.innerHTML = `
          <span>${e.sys}/${e.dia}</span>
          <span class="tag">üïí ${e.tod || "‚Äî"}</span>
          ${Number.isFinite(e.pulse) ? `<span class="tag">‚ù§Ô∏è ${e.pulse} bpm</span>` : ""}
          ${e.arm ? `<span class="tag">ü¶æ ${e.arm}</span>` : ""}
        `;

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `${formatDateTime(e.ts)}${e.note ? " ‚Ä¢ " + e.note : ""}`;

        left.appendChild(bp);
        left.appendChild(meta);

        const del = document.createElement("button");
        del.className = "smallbtn danger";
        del.textContent = "DEL";
        del.title = "Delete entry";
        del.onclick = () => {
          const next = loadEntries().filter(x => x.id !== e.id);
          saveEntries(next);
          render();
        };

        item.appendChild(left);
        item.appendChild(del);

        list.appendChild(item);
      }

      // Averages (overall + time windows + morning/evening)
      const avg7d = calcAvg(withinDays(entries, 7));
      const avg30d = calcAvg(withinDays(entries, 30));
      const avgAllt = calcAvg(entries);

      const morn = entries.filter(e => (e.tod || "") === "Morning");
      const eve = entries.filter(e => (e.tod || "") === "Evening");
      const avgM = calcAvg(morn);
      const avgE = calcAvg(eve);

      const fmtBP = (a) => a ? `${a.sys.toFixed(0)}/${a.dia.toFixed(0)}` : "‚Äì";

      avg7.textContent = fmtBP(avg7d);
      avg30.textContent = fmtBP(avg30d);
      avgAll.textContent = fmtBP(avgAllt);
      avgMorning.textContent = fmtBP(avgM);
      avgEvening.textContent = fmtBP(avgE);

      const p = avgAllt && avgAllt.pulse ? avgAllt.pulse.toFixed(0) : "‚Äì";
      avgPulse.textContent = p;

      // Chart
      drawChart(entries);
    }

    function tickClock(){
      nowPill.textContent = `Now: ${formatDateTime(Date.now())}`;
      lockTimePill.textContent = `Now: ${formatDateTime(Date.now())}`;
    }

    // ----------------------------
    // Events
    // ----------------------------
    timeMode.addEventListener("change", () => {
      manualTimeRow.style.display = timeMode.value === "manual" ? "grid" : "none";
    });

    addBtn.addEventListener("click", () => {
      const s = num(sys.value);
      const d = num(dia.value);
      const p = num(pulse.value);

      if(!Number.isFinite(s) || !Number.isFinite(d)){
        alert("Please enter both Systolic (SYS) and Diastolic (DIA).");
        return;
      }

      const safeSys = clamp(s, 50, 260);
      const safeDia = clamp(d, 30, 160);
      const safePulse = Number.isFinite(p) ? clamp(p, 30, 220) : null;

      let ts = Date.now();
      if(timeMode.value === "manual"){
        if(!manualTime.value){
          alert("Pick a date/time first (or switch Timestamp back to current).");
          return;
        }
        ts = new Date(manualTime.value).getTime();
      }

      const entry = {
        id: crypto?.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2),
        ts,
        sys: safeSys,
        dia: safeDia,
        pulse: safePulse,
        tod: tod.value || "Morning",
        arm: arm.value || "",
        note: (note.value || "").trim()
      };

      const entries = loadEntries();
      entries.push(entry);
      saveEntries(entries);

      // Reset some fields
      sys.value = "";
      dia.value = "";
      pulse.value = "";
      note.value = "";
      arm.value = "";

      render();
    });

    clearBtn.addEventListener("click", () => {
      const ok = confirm("Clear ALL entries? This can't be undone.");
      if(!ok) return;
      localStorage.removeItem(STORAGE_KEY);
      render();
    });

    exportJsonBtn.addEventListener("click", () => {
      const entries = loadEntries().sort((a,b)=>b.ts - a.ts);
      const blob = new Blob([JSON.stringify(entries, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `bp-logger-export-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    exportCsvBtn.addEventListener("click", () => {
      const entries = loadEntries().sort((a,b)=>a.ts - b.ts); // oldest->newest for doctors
      const header = ["DateTime","Systolic","Diastolic","Pulse","TimeOfDay","Arm","Note"];
      const rows = [header.join(",")];

      for(const e of entries){
        const row = [
          `"${formatISOForCsv(e.ts)}"`,
          e.sys ?? "",
          e.dia ?? "",
          (Number.isFinite(e.pulse) ? e.pulse : ""),
          `"${(e.tod || "").replaceAll('"','""')}"`,
          `"${(e.arm || "").replaceAll('"','""')}"`,
          `"${(e.note || "").replaceAll('"','""')}"`
        ];
        rows.push(row.join(","));
      }

      const csv = rows.join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `bp-logger-export-${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    lockBtn.addEventListener("click", async () => {
      await pinSettingsFlow();
      // If PIN enabled, immediately show lock so user sees it works
      if(hasPin()) showLock();
    });

    unlockBtn.addEventListener("click", tryUnlock);
    pinInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter") tryUnlock();
    });

    lockHelpBtn.addEventListener("click", () => {
      alert("Forgot PIN?\n\nThis app stores only a PIN hash locally.\nTo reset, you must clear site data/localStorage for this file (or use Clear All + remove PIN from storage via browser settings).");
    });

    // If user switches tabs and comes back, you can optionally re-lock.
    document.addEventListener("visibilitychange", () => {
      if(document.visibilityState === "visible" && hasPin()){
        showLock();
      }
    });

    // ----------------------------
    // Init
    // ----------------------------
    function init(){
      render();
      tickClock();
      setInterval(tickClock, 1000 * 10);

      // Lock on load if PIN exists
      if(hasPin()){
        showLock();
      }

      // Make canvas crisp on retina displays
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      // Use fixed internal resolution for consistent look, scale for DPR
      const targetW = 900, targetH = 300;
      canvas.width = Math.floor(targetW * dpr);
      canvas.height = Math.floor(targetH * dpr);
      canvas.style.width = "100%";
      canvas.style.height = "190px";
      ctx.setTransform(dpr,0,0,dpr,0,0); // scale drawing coordinates
      // After resizing, redraw
      render();
    }

    window.addEventListener("resize", () => {
      // Redraw chart on resize (layout changes)
      render();
    });

    init();
  </script>
</body>
</html>
